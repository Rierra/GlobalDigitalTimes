name: Auto News Pipeline

on:
  # Run every 30 minutes for fast news detection
  schedule:
    - cron: '*/30 * * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (no publishing)'
        required: false
        default: 'false'
        type: boolean
      limit:
        description: 'Max articles to process (0 = use queue system)'
        required: false
        default: '0'
        type: string

jobs:
  generate-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Auto News Radar Pipeline
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          LEONARDO_API_KEY: ${{ secrets.LEONARDO_API_KEY }}
        run: |
          LIMIT="${{ github.event.inputs.limit || '0' }}"
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            if [ "$LIMIT" != "0" ]; then
              python -m auto_news.orchestrator --test --limit $LIMIT
            else
              python -m auto_news.orchestrator --test
            fi
          else
            if [ "$LIMIT" != "0" ]; then
              python -m auto_news.orchestrator --limit $LIMIT
            else
              python -m auto_news.orchestrator
            fi
          fi
      
      - name: Check for changes
        id: check_changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Auto News Bot"
          git commit -m "ðŸ¤– Auto: New articles generated - $(date +'%Y-%m-%d %H:%M')"
          git push
      
      - name: Summary
        run: |
          echo "## ðŸ“° Auto News Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes:** ${{ steps.check_changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "auto_news.log" ]; then
            echo "### Recent Log" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -20 auto_news.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
